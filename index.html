<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SaveMySnaps - R√©cup√®re tes Memories Snapchat</title>
    <meta name="description"
        content="R√©cup√®re facilement tes Memories Snapchat dans ta galerie. Outil gratuit, traitement 100% local et s√©curis√©.">

    <script src="https://quge5.com/88/tag.min.js" data-zone="190828" async data-cfasync="false"></script>
    <!-- =============================================
         LIBRAIRIES CDN
         ============================================= -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter pour un style √©pur√© -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- JSZip pour le traitement des fichiers ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js pour le t√©l√©chargement -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- =============================================
         STYLES PERSONNALIS√âS
         ============================================= -->
    <style>
        /* Police personnalis√©e */
        * {
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            min-height: 100dvh;
            overscroll-behavior: none;
        }

        /* Animation douce pour le bouton principal */
        @keyframes gentle-pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .btn-pulse {
            animation: gentle-pulse 3s ease-in-out infinite;
        }

        /* Animation de chargement */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Zone de drop stylis√©e */
        .drop-zone {
            border: 2px dashed;
            transition: all 0.3s ease;
        }

        .drop-zone.dragover {
            border-color: #fb923c;
            background-color: rgba(251, 146, 60, 0.05);
            transform: scale(1.01);
        }

        /* Accord√©on personnalis√© */
        details summary {
            cursor: pointer;
            list-style: none;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary .chevron {
            transform: rotate(180deg);
        }

        .chevron {
            transition: transform 0.3s ease;
        }

        /* Overlay avec blur */
        .overlay-blur {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Barre de progression */
        .progress-bar {
            transition: width 0.3s ease;
        }

        /* Scrollbar personnalis√©e style minimaliste */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f5f5f4;
        }

        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }
    </style>
</head>

<body class="bg-stone-100 text-stone-800">

    <!-- =============================================
         SECTION A : HEADER
         ============================================= -->
    <header class="sticky top-0 z-40 bg-stone-100/90 backdrop-blur-md border-b border-stone-200">
        <div class="max-w-lg mx-auto px-4 py-4">
            <div class="text-center">
                <!-- Logo et Titre -->
                <h1 class="text-2xl font-bold flex items-center justify-center gap-2 text-stone-800">
                    <span class="text-3xl opacity-80">üëª</span>
                    <span>SaveMySnaps</span>
                </h1>
                <!-- Sous-titre accrocheur -->
                <p class="text-stone-500 text-sm mt-1">
                    R√©cup√®re tes Memories dans ta galerie
                </p>
            </div>
        </div>
    </header>

    <!-- =============================================
         CONTENU PRINCIPAL
         ============================================= -->
    <main class="max-w-lg mx-auto px-4 py-6 space-y-5 pb-24">

        <!-- =============================================
             SECTION B : TUTORIEL "COMMENT FAIRE ?"
             ============================================= -->
        <section>
            <details
                class="bg-stone-50 rounded-3xl overflow-hidden border border-stone-200 shadow-lg shadow-stone-300/30 transition-all duration-300"
                open>
                <summary class="p-5 flex items-center justify-between hover:bg-stone-100 transition-all duration-300">
                    <div class="flex items-center gap-3">
                        <span
                            class="bg-orange-100 text-orange-500 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">1</span>
                        <span class="font-semibold text-stone-700">Comment obtenir mes donn√©es ?</span>
                    </div>
                    <svg class="chevron w-5 h-5 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </summary>

                <div class="px-5 pb-5 space-y-4">
                    <!-- √âtapes du tutoriel avec emojis -->
                    <div class="space-y-3">
                        <div
                            class="flex gap-3 items-start p-4 bg-white rounded-2xl border border-stone-100 transition-all duration-300">
                            <span class="text-xl">‚öôÔ∏è</span>
                            <p class="text-sm text-stone-600">Ouvre les <strong class="text-stone-800">R√©glages</strong>
                                Snapchat</p>
                        </div>

                        <div
                            class="flex gap-3 items-start p-4 bg-white rounded-2xl border border-stone-100 transition-all duration-300">
                            <span class="text-xl">üìú</span>
                            <p class="text-sm text-stone-600">Scrolle vers <strong class="text-stone-800">"Mes
                                    Donn√©es"</strong></p>
                        </div>

                        <div
                            class="flex gap-3 items-start p-4 bg-white rounded-2xl border border-stone-100 transition-all duration-300">
                            <span class="text-xl">‚úÖ</span>
                            <p class="text-sm text-stone-600">Coche uniquement <strong
                                    class="text-stone-800">"Memories"</strong></p>
                        </div>

                        <div
                            class="flex gap-3 items-start p-4 bg-white rounded-2xl border border-stone-100 transition-all duration-300">
                            <span class="text-xl">üì©</span>
                            <p class="text-sm text-stone-600">Entre ton email, tu recevras le <strong
                                    class="text-stone-800">lien</strong> sous 24h</p>
                        </div>
                    </div>

                    <!-- Bouton CTA vers Snapchat -->
                    <a href="https://accounts.snapchat.com/accounts/downloadmydata" target="_blank"
                        rel="noopener noreferrer"
                        class="block w-full bg-stone-800 hover:bg-stone-700 text-stone-50 text-center py-4 rounded-full font-medium transition-all duration-300 shadow-md shadow-stone-400/20">
                        Acc√©der √† Snapchat ‚Üí
                    </a>
                </div>
            </details>
        </section>

        <!-- =============================================
             SECTION C : UPLOAD ET TRAITEMENT
             ============================================= -->
        <section>
            <div class="bg-white rounded-3xl p-5 border border-stone-200 shadow-xl shadow-stone-300/50">
                <!-- Titre de la section -->
                <div class="flex items-center gap-3 mb-5">
                    <span
                        class="bg-orange-100 text-orange-500 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">2</span>
                    <span class="font-semibold text-stone-700">Importe ton fichier ZIP</span>
                </div>

                <!-- Zone de Drop / Upload -->
                <div id="dropZone"
                    class="drop-zone border-stone-300 rounded-3xl p-8 text-center cursor-pointer hover:border-orange-300 hover:bg-orange-50/30 transition-all duration-300">
                    <input type="file" id="fileInput" accept=".zip" class="hidden">

                    <div id="uploadContent">
                        <div class="w-16 h-16 mx-auto mb-4 bg-stone-100 rounded-full flex items-center justify-center">
                            <span class="text-3xl">üìÅ</span>
                        </div>
                        <p class="font-medium text-stone-700 mb-1">Glisse ton fichier ici</p>
                        <p class="text-stone-400 text-sm mb-4">ou clique pour s√©lectionner</p>
                        <div
                            class="inline-block bg-stone-800 hover:bg-stone-700 text-stone-50 font-medium py-3 px-6 rounded-full transition-all duration-300 shadow-md shadow-stone-400/20">
                            Choisir un fichier
                        </div>
                    </div>

                    <!-- √âtat de chargement (cach√© par d√©faut) -->
                    <div id="loadingContent" class="hidden">
                        <div class="w-16 h-16 mx-auto mb-4 bg-orange-100 rounded-full flex items-center justify-center">
                            <span class="text-3xl animate-spin">‚öôÔ∏è</span>
                        </div>
                        <p class="font-medium text-stone-700 mb-1">Analyse en cours...</p>
                        <p class="text-stone-400 text-sm" id="loadingStatus">Lecture du fichier</p>
                    </div>
                </div>

                <!-- Barre de progression (cach√©e par d√©faut) -->
                <div id="progressContainer" class="hidden mt-4">
                    <div class="flex justify-between text-sm text-stone-500 mb-2">
                        <span id="progressText">Traitement...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="h-2 bg-stone-200 rounded-full overflow-hidden">
                        <div id="progressBar"
                            class="progress-bar h-full bg-gradient-to-r from-orange-300 to-stone-400 rounded-full"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- =============================================
             SECTION D : R√âSULTAT & MON√âTISATION
             (Cach√©e par d√©faut, affich√©e apr√®s le traitement)
             ============================================= -->
        <section id="resultSection" class="hidden">
            <div class="bg-white rounded-3xl p-5 border border-stone-200 shadow-xl shadow-stone-300/50">
                <!-- R√©sultat du scan -->
                <div class="text-center mb-6">
                    <div
                        class="w-20 h-20 mx-auto bg-green-50 rounded-full flex items-center justify-center mb-4 border border-green-100">
                        <span class="text-4xl">üîó</span>
                    </div>
                    <p class="text-3xl font-bold text-stone-800 mb-1">
                        <span id="fileCount">0</span> Memories
                    </p>
                    <p class="text-stone-500">liens d√©tect√©s dans ton export</p>
                </div>

                <!-- D√©tails des fichiers -->
                <div id="fileDetails" class="grid grid-cols-2 gap-3 mb-6">
                    <!-- Rempli dynamiquement -->
                </div>

                <!-- Message sp√©cifique iOS -->
                <div class="bg-stone-50 rounded-2xl p-4 mb-6 border border-stone-100">
                    <div class="flex gap-3 items-start">
                        <span class="text-xl">üì±</span>
                        <div class="text-sm">
                            <p class="font-medium text-stone-700 mb-1">Astuce iPhone</p>
                            <p class="text-stone-500">Enregistre d'abord dans "Fichiers", puis sauvegarde dans ta
                                Galerie.</p>
                        </div>
                    </div>
                </div>

                <!-- Bouton Magique -->
                <button id="downloadBtn"
                    class="btn-pulse w-full bg-stone-800 hover:bg-stone-700 text-stone-50 font-semibold text-lg py-4 rounded-full transition-all duration-300 active:scale-[0.98] shadow-lg shadow-stone-400/30">
                    üîì D√©bloquer & T√©l√©charger
                </button>

                <!-- Mention l√©gale -->
                <p class="text-center text-stone-400 text-xs mt-4">
                    Une courte pub te sera pr√©sent√©e pour supporter le service
                </p>
            </div>
        </section>

        <!-- =============================================
             MESSAGE D'ERREUR (Cach√© par d√©faut)
             ============================================= -->
        <section id="errorSection" class="hidden">
            <div class="bg-red-50 border border-red-100 rounded-3xl p-5 text-center">
                <div class="w-16 h-16 mx-auto bg-red-100 rounded-full flex items-center justify-center mb-3">
                    <span class="text-3xl">‚ùå</span>
                </div>
                <p class="text-red-600 font-semibold mb-2" id="errorTitle">Erreur</p>
                <p class="text-stone-500 text-sm" id="errorMessage">Une erreur est survenue</p>
                <button id="retryBtn"
                    class="mt-4 bg-stone-100 text-stone-700 font-medium py-3 px-6 rounded-full hover:bg-stone-200 transition-all duration-300">
                    R√©essayer
                </button>
            </div>
        </section>

        <!-- =============================================
             MESSAGE ERREUR CORS (Cach√© par d√©faut)
             ============================================= -->
        <section id="corsErrorSection" class="hidden">
            <div class="bg-amber-50 border border-amber-200 rounded-3xl p-5">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 mx-auto bg-amber-100 rounded-full flex items-center justify-center mb-3">
                        <span class="text-3xl">üîí</span>
                    </div>
                    <p class="text-amber-700 font-semibold mb-2">Snapchat bloque le t√©l√©chargement</p>
                    <p class="text-stone-500 text-sm">Les serveurs de Snapchat emp√™chent le t√©l√©chargement direct depuis
                        un navigateur.</p>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="bg-white rounded-2xl p-4 border border-amber-100">
                        <p class="font-medium text-stone-700 mb-2">üíª Sur ordinateur :</p>
                        <p class="text-stone-500">Utilise une extension comme "CORS Unblock" puis r√©essaie.</p>
                    </div>
                    <div class="bg-white rounded-2xl p-4 border border-amber-100">
                        <p class="font-medium text-stone-700 mb-2">üì± Sur mobile :</p>
                        <p class="text-stone-500">Ouvre le fichier memories_history.html dans ton ZIP et clique
                            manuellement sur chaque lien "Download".</p>
                    </div>
                </div>

                <button id="retryCorsBtn"
                    class="mt-4 w-full bg-stone-800 text-stone-50 font-medium py-3 rounded-full hover:bg-stone-700 transition-all duration-300">
                    R√©essayer quand m√™me
                </button>
            </div>
        </section>

    </main>

    <!-- =============================================
         FOOTER
         ============================================= -->
    <footer class="fixed bottom-0 left-0 right-0 bg-stone-100/90 backdrop-blur-md border-t border-stone-200 py-3">
        <p class="text-center text-stone-400 text-xs">
            üîí 100% local ‚Ä¢ Tes donn√©es restent sur ton appareil
        </p>
    </footer>

    <!-- =============================================
         OVERLAY PUBLICITAIRE (Cach√© par d√©faut)
         ============================================= -->
    <div id="adOverlay" class="hidden fixed inset-0 z-50 bg-stone-100/95 overlay-blur flex items-center justify-center">
        <div class="text-center p-8 max-w-sm">
            <div class="w-24 h-24 mx-auto bg-stone-200 rounded-full flex items-center justify-center mb-6">
                <span class="text-5xl">üì∫</span>
            </div>
            <p class="text-xl font-semibold mb-2 text-stone-700">Publicit√© en cours...</p>
            <p class="text-stone-500 mb-6">Merci de supporter SaveMySnaps</p>

            <!-- D√©compte -->
            <div class="relative w-20 h-20 mx-auto mb-6">
                <svg class="w-20 h-20 transform -rotate-90">
                    <circle cx="40" cy="40" r="36" stroke="#e7e5e4" stroke-width="6" fill="none" />
                    <circle id="adProgress" cx="40" cy="40" r="36" stroke="#44403c" stroke-width="6" fill="none"
                        stroke-dasharray="226.19" stroke-dashoffset="226.19" stroke-linecap="round" />
                </svg>
                <span id="adCountdown"
                    class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-stone-700">3</span>
            </div>

            <p class="text-stone-400 text-sm">Le t√©l√©chargement d√©marre automatiquement</p>
        </div>
    </div>

    <!-- =============================================
         OVERLAY DE T√âL√âCHARGEMENT (Cach√© par d√©faut)
         ============================================= -->
    <div id="downloadOverlay"
        class="hidden fixed inset-0 z-50 bg-stone-100/95 overlay-blur flex items-center justify-center">
        <div class="text-center p-8 max-w-sm w-full">
            <div class="w-24 h-24 mx-auto bg-orange-100 rounded-full flex items-center justify-center mb-6">
                <span class="text-5xl" id="downloadEmoji">üì•</span>
            </div>
            <p class="text-xl font-semibold mb-2 text-stone-700" id="downloadTitle">R√©cup√©ration en cours...</p>
            <p class="text-stone-500 mb-4" id="downloadStatus">Connexion aux serveurs Snapchat</p>

            <!-- Barre de progression d√©taill√©e -->
            <div class="w-full mx-auto mb-4">
                <div class="h-3 bg-stone-200 rounded-full overflow-hidden">
                    <div id="downloadBar"
                        class="progress-bar h-full bg-gradient-to-r from-orange-300 to-orange-500 rounded-full"
                        style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-2 text-sm">
                    <span class="text-stone-500" id="downloadCount">0 / 0</span>
                    <span class="text-stone-500" id="downloadPercent">0%</span>
                </div>
            </div>

            <!-- Fichier en cours -->
            <p class="text-stone-400 text-xs truncate" id="currentFile">-</p>
        </div>
    </div>

    <!-- =============================================
         JAVASCRIPT - LOGIQUE PRINCIPALE (LINK EXTRACTOR)
         ============================================= -->
    <script>
        // =============================================
        // VARIABLES GLOBALES
        // =============================================

        // Stockage des URLs extraites
        let extractedUrls = [];
        // Nombre de t√©l√©chargements simultan√©s
        const BATCH_SIZE = 3;
        // Compteur d'erreurs CORS
        let corsErrors = 0;

        // =============================================
        // √âL√âMENTS DU DOM
        // =============================================

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadContent = document.getElementById('uploadContent');
        const loadingContent = document.getElementById('loadingContent');
        const loadingStatus = document.getElementById('loadingStatus');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const resultSection = document.getElementById('resultSection');
        const fileCount = document.getElementById('fileCount');
        const fileDetails = document.getElementById('fileDetails');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorSection = document.getElementById('errorSection');
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const retryBtn = document.getElementById('retryBtn');
        const corsErrorSection = document.getElementById('corsErrorSection');
        const retryCorsBtn = document.getElementById('retryCorsBtn');
        const adOverlay = document.getElementById('adOverlay');
        const adCountdown = document.getElementById('adCountdown');
        const adProgress = document.getElementById('adProgress');
        const downloadOverlay = document.getElementById('downloadOverlay');
        const downloadTitle = document.getElementById('downloadTitle');
        const downloadStatus = document.getElementById('downloadStatus');
        const downloadBar = document.getElementById('downloadBar');
        const downloadCount = document.getElementById('downloadCount');
        const downloadPercent = document.getElementById('downloadPercent');
        const downloadEmoji = document.getElementById('downloadEmoji');
        const currentFile = document.getElementById('currentFile');

        // =============================================
        // GESTION DU DRAG & DROP
        // =============================================

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('dragover');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('dragover');
            }, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        }

        // =============================================
        // TRAITEMENT DU FICHIER ZIP (EXTRACTION DES LIENS)
        // =============================================

        async function processFile(file) {
            resetState();

            if (!file.name.toLowerCase().endsWith('.zip')) {
                showError('Format non support√©', 'Merci d\'importer un fichier .ZIP');
                return;
            }

            uploadContent.classList.add('hidden');
            loadingContent.classList.remove('hidden');
            progressContainer.classList.remove('hidden');

            try {
                updateProgress('Lecture du fichier ZIP...', 10);
                const zip = await JSZip.loadAsync(file);

                // Chercher le fichier memories_history.html
                updateProgress('Recherche de memories_history.html...', 30);

                let memoriesHtml = null;
                const possiblePaths = [
                    'html/memories_history.html',
                    'memories_history.html',
                    'Memories/memories_history.html'
                ];

                for (const path of possiblePaths) {
                    if (zip.files[path]) {
                        memoriesHtml = await zip.files[path].async('string');
                        break;
                    }
                }

                // Si pas trouv√©, chercher r√©cursivement
                if (!memoriesHtml) {
                    for (const [path, zipEntry] of Object.entries(zip.files)) {
                        if (path.toLowerCase().includes('memories_history.html') && !zipEntry.dir) {
                            memoriesHtml = await zipEntry.async('string');
                            break;
                        }
                    }
                }

                if (!memoriesHtml) {
                    showError(
                        'Fichier introuvable',
                        'Le fichier memories_history.html n\'a pas √©t√© trouv√© dans ce ZIP. Assure-toi d\'avoir export√© tes "Memories" depuis Snapchat.'
                    );
                    return;
                }

                // Extraire les URLs
                updateProgress('Extraction des liens...', 60);
                extractedUrls = extractDownloadUrls(memoriesHtml);

                if (extractedUrls.length === 0) {
                    showError(
                        'Aucun lien trouv√©',
                        'Aucun lien de t√©l√©chargement n\'a √©t√© d√©tect√© dans le fichier.'
                    );
                    return;
                }

                updateProgress('Analyse termin√©e !', 100);
                showResults();

            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de lecture', 'Impossible de lire ce fichier ZIP.');
            }
        }

        // =============================================
        // EXTRACTION DES URLS (REGEX)
        // =============================================

        function extractDownloadUrls(htmlContent) {
            const urls = [];

            // Regex pour trouver les appels downloadMemories('URL', ...)
            // Format: downloadMemories('https://...', ...)
            const regex = /downloadMemories\s*\(\s*['"]([^'"]+)['"]/g;
            let match;

            while ((match = regex.exec(htmlContent)) !== null) {
                let url = match[1];
                // D√©coder les entit√©s HTML (&amp; -> &)
                url = url.replace(/&amp;/g, '&');
                urls.push({
                    url: url,
                    index: urls.length + 1
                });
            }

            // M√©thode alternative : chercher les liens directs Snapchat
            if (urls.length === 0) {
                const altRegex = /href=["']?(https:\/\/[^"'\s]*snapchat\.com[^"'\s]*download[^"'\s]*)["']?/gi;
                while ((match = altRegex.exec(htmlContent)) !== null) {
                    let url = match[1];
                    url = url.replace(/&amp;/g, '&');
                    urls.push({
                        url: url,
                        index: urls.length + 1
                    });
                }
            }

            console.log(`${urls.length} URLs extraites`);
            return urls;
        }

        // =============================================
        // AFFICHAGE DES R√âSULTATS
        // =============================================

        function showResults() {
            loadingContent.classList.add('hidden');
            progressContainer.classList.add('hidden');
            uploadContent.classList.add('hidden');

            fileCount.textContent = extractedUrls.length;

            fileDetails.innerHTML = `
                <div class="bg-stone-50 rounded-2xl p-4 text-center border border-stone-100 col-span-2">
                    <p class="text-2xl mb-1">üîó</p>
                    <p class="text-xl font-bold text-stone-800">${extractedUrls.length}</p>
                    <p class="text-stone-500 text-sm">Liens de t√©l√©chargement pr√™ts</p>
                </div>
            `;

            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // =============================================
        // GESTION DE LA PUBLICIT√â
        // =============================================

        downloadBtn.addEventListener('click', showAd);
        retryCorsBtn.addEventListener('click', () => {
            corsErrorSection.classList.add('hidden');
            showAd();
        });

        function showAd() {
            adOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            let countdown = 3;
            adCountdown.textContent = countdown;

            const circumference = 2 * Math.PI * 36;
            let progress = 0;

            const interval = setInterval(() => {
                progress += (100 / 30);
                const offset = circumference - (progress / 100) * circumference;
                adProgress.style.strokeDashoffset = offset;
            }, 100);

            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    adCountdown.textContent = countdown;
                } else {
                    adCountdown.textContent = '‚úì';
                }
            }, 1000);

            setTimeout(() => {
                clearInterval(interval);
                clearInterval(countdownInterval);
                adOverlay.classList.add('hidden');
                document.body.style.overflow = '';
                startBatchDownload();
            }, 3000);
        }

        // =============================================
        // T√âL√âCHARGEMENT PAR LOTS (BATCH FETCH)
        // =============================================

        async function startBatchDownload() {
            downloadOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            corsErrors = 0;

            const newZip = new JSZip();
            const total = extractedUrls.length;
            let processed = 0;
            let successful = 0;

            // Traitement par lots
            for (let i = 0; i < extractedUrls.length; i += BATCH_SIZE) {
                const batch = extractedUrls.slice(i, i + BATCH_SIZE);

                const results = await Promise.allSettled(
                    batch.map(async (item) => {
                        try {
                            currentFile.textContent = `Memory #${item.index}`;

                            // Essayer d'abord en mode normal
                            let response = await fetch(item.url, {
                                method: 'GET',
                                mode: 'cors',
                                credentials: 'omit'
                            });

                            // Si √©chec, essayer avec POST (format Snapchat)
                            if (!response.ok) {
                                response = await fetch(item.url, {
                                    method: 'POST',
                                    mode: 'cors',
                                    credentials: 'omit',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded'
                                    }
                                });
                            }

                            if (response.ok) {
                                const blob = await response.blob();

                                // D√©terminer l'extension
                                const contentType = response.headers.get('content-type') || '';
                                let ext = '.jpg';
                                if (contentType.includes('video') || contentType.includes('mp4')) {
                                    ext = '.mp4';
                                } else if (contentType.includes('png')) {
                                    ext = '.png';
                                } else if (contentType.includes('mov') || contentType.includes('quicktime')) {
                                    ext = '.mov';
                                }

                                // Nom du fichier
                                const date = new Date();
                                const fileName = `Memory_${String(item.index).padStart(4, '0')}${ext}`;

                                return { fileName, blob, success: true };
                            } else {
                                throw new Error(`HTTP ${response.status}`);
                            }
                        } catch (error) {
                            console.error(`Erreur pour #${item.index}:`, error);
                            if (error.message.includes('CORS') || error.name === 'TypeError') {
                                corsErrors++;
                            }
                            return { success: false, index: item.index };
                        }
                    })
                );

                // Ajouter les fichiers r√©ussis au ZIP
                for (const result of results) {
                    processed++;

                    if (result.status === 'fulfilled' && result.value.success) {
                        newZip.file(result.value.fileName, result.value.blob);
                        successful++;
                    }

                    // Mise √† jour de la progression
                    const percent = Math.round((processed / total) * 100);
                    downloadBar.style.width = `${percent}%`;
                    downloadCount.textContent = `${processed} / ${total}`;
                    downloadPercent.textContent = `${percent}%`;
                    downloadStatus.textContent = `R√©cup√©ration : ${successful} r√©ussis`;
                }

                // V√©rifier si trop d'erreurs CORS
                if (corsErrors > 5 && processed < total / 2) {
                    downloadOverlay.classList.add('hidden');
                    document.body.style.overflow = '';
                    corsErrorSection.classList.remove('hidden');
                    corsErrorSection.scrollIntoView({ behavior: 'smooth' });
                    return;
                }
            }

            // Finalisation
            if (successful > 0) {
                downloadTitle.textContent = 'Cr√©ation du ZIP...';
                downloadEmoji.textContent = 'üì¶';
                downloadStatus.textContent = 'Compression des fichiers';

                const blob = await newZip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                saveAs(blob, `SaveMySnaps_${dateStr}_${successful}memories.zip`);

                downloadTitle.textContent = 'Termin√© !';
                downloadEmoji.textContent = '‚úÖ';
                downloadStatus.textContent = `${successful} Memories sauvegard√©s`;

                setTimeout(() => {
                    downloadOverlay.classList.add('hidden');
                    document.body.style.overflow = '';

                    downloadBtn.innerHTML = '‚úì T√©l√©chargement termin√© !';
                    downloadBtn.classList.remove('btn-pulse');
                    downloadBtn.disabled = true;
                    downloadBtn.classList.add('opacity-60', 'cursor-not-allowed');
                }, 2000);
            } else {
                downloadOverlay.classList.add('hidden');
                document.body.style.overflow = '';
                corsErrorSection.classList.remove('hidden');
            }
        }

        // =============================================
        // FONCTIONS UTILITAIRES
        // =============================================

        function updateProgress(text, percent) {
            progressText.textContent = text;
            progressPercent.textContent = `${percent}%`;
            progressBar.style.width = `${percent}%`;
            loadingStatus.textContent = text;
        }

        function showError(title, message) {
            loadingContent.classList.add('hidden');
            progressContainer.classList.add('hidden');
            resultSection.classList.add('hidden');
            corsErrorSection.classList.add('hidden');
            uploadContent.classList.remove('hidden');

            errorTitle.textContent = title;
            errorMessage.textContent = message;
            errorSection.classList.remove('hidden');
        }

        function resetState() {
            extractedUrls = [];
            corsErrors = 0;

            errorSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            corsErrorSection.classList.add('hidden');
            loadingContent.classList.add('hidden');
            progressContainer.classList.add('hidden');

            uploadContent.classList.remove('hidden');
            progressBar.style.width = '0%';
            downloadBar.style.width = '0%';

            downloadBtn.innerHTML = 'üîì D√©bloquer & T√©l√©charger';
            downloadBtn.classList.add('btn-pulse');
            downloadBtn.disabled = false;
            downloadBtn.classList.remove('opacity-60', 'cursor-not-allowed');

            downloadTitle.textContent = 'R√©cup√©ration en cours...';
            downloadEmoji.textContent = 'üì•';
            downloadStatus.textContent = 'Connexion aux serveurs Snapchat';

            fileInput.value = '';
        }

        retryBtn.addEventListener('click', resetState);

        // =============================================
        // LOG DE D√âVELOPPEMENT
        // =============================================

        console.log('%cüì∏ SaveMySnaps - Link Extractor v2.0', 'font-size: 16px; font-weight: bold; color: #44403c;');
        console.log('%cExtracts download links from Snapchat exports', 'color: #a8a29e;');
    </script>
</body>

</html>